{{/* =========================================================
   Slack Templates for Alertmanager
   Templates:
     - slack.title
     - slack.text
   ========================================================= */}}

{{/* -------------------------
   Title
   ------------------------- */}}
{{ define "slack.title" -}}
{{- if eq .Status "firing" -}}ðŸš¨ FIRING{{- else -}}âœ… RESOLVED{{- end -}}
 | {{- with (index .CommonLabels "severity") -}}{{ . | toUpper }}{{- else -}}UNKNOWN{{- end -}}
 | {{- with (index .CommonLabels "alertname") -}}{{ . }}{{- else -}}Alert{{- end -}}
{{- end }}


{{/* -------------------------
   Body
   ------------------------- */}}
{{ define "slack.text" -}}

{{- $sep := "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -}}

{{/* Summary */}}
{{ $sep }}
{{- with (index .CommonAnnotations "summary") -}}
*Summary:* {{ . }}
{{- else -}}
*Summary:* _(no summary annotation)_
{{- end -}}

{{/* Description */}}
{{- with (index .CommonAnnotations "description") }}
{{ "\n" }}*Description:*{{ "\n" }}{{ . }}
{{- end }}

{{/* Key labels */}}
{{ "\n" }}*Key labels:*{{ "\n" -}}
{{- with (index .CommonLabels "namespace") -}}â€¢ *namespace:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "job") -}}â€¢ *job:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "instance") -}}â€¢ *instance:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "pod") -}}â€¢ *pod:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "service") -}}â€¢ *service:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "controller") -}}â€¢ *controller:* `{{ . }}`{{ "\n" }}{{- end -}}

{{/* Other labels (filtered) */}}
{{- $extra := "" -}}
{{- range .CommonLabels.SortedPairs -}}
{{- if and
    (ne .Name "alertname")
    (ne .Name "severity")
    (ne .Name "namespace")
    (ne .Name "job")
    (ne .Name "instance")
    (ne .Name "pod")
    (ne .Name "service")
    (ne .Name "controller")
  -}}
{{- $extra = printf "%sâ€¢ *%s:* `%s`\n" $extra .Name .Value -}}
{{- end -}}
{{- end -}}
{{- if $extra -}}
{{ "\n" }}*Other labels:*{{ "\n" }}{{ $extra -}}
{{- end -}}

{{/* Links */}}
{{- $hasLinks := false -}}
{{- with (index .CommonAnnotations "runbook_url") }}{{ $hasLinks = true }}{{ end -}}
{{- with (index .CommonAnnotations "grafana_url") }}{{ $hasLinks = true }}{{ end -}}
{{- if .ExternalURL }}{{ $hasLinks = true }}{{ end -}}

{{- if $hasLinks -}}
{{ $sep }}
*Links:*
{{- with (index .CommonAnnotations "runbook_url") }}
{{ "\n" }}â€¢ <{{ . }}|ðŸ“˜ Runbook>
{{- end -}}
{{- with (index .CommonAnnotations "grafana_url") }}
{{ "\n" }}â€¢ <{{ . }}|ðŸ“ˆ Grafana>
{{- end -}}
{{- if .ExternalURL }}
{{ "\n" }}â€¢ <{{ .ExternalURL }}|ðŸ”— Alertmanager>
{{- end -}}
{{- end -}}

{{- end }}
