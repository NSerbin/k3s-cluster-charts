{{/* =========================
   Slack Templates (Alertmanager)
   - slack.title
   - slack.text
   ========================= */}}

{{- define "slack.title" -}}
{{- $status := .Status | toUpper -}}
{{- $sev := "UNKNOWN" -}}
{{- with (index .CommonLabels "severity") -}}{{- $sev = (. | toUpper) -}}{{- end -}}
{{- $an := "Alert" -}}
{{- with (index .CommonLabels "alertname") -}}{{- $an = . -}}{{- end -}}
{{- if eq $status "FIRING" -}}ðŸš¨{{- else -}}âœ…{{- end -}} {{ $status }} | {{ $sev }} | {{ $an }}
{{- end -}}

{{- define "slack.text" -}}
{{- $summary := "" -}}
{{- with (index .CommonAnnotations "summary") -}}{{- $summary = . -}}{{- end -}}
{{- $desc := "" -}}
{{- with (index .CommonAnnotations "description") -}}{{- $desc = . -}}{{- end -}}
{{- $runbook := "" -}}
{{- with (index .CommonAnnotations "runbook_url") -}}{{- $runbook = . -}}{{- end -}}
{{- $grafana := "" -}}
{{- with (index .CommonAnnotations "grafana_url") -}}{{- $grafana = . -}}{{- end -}}

{{- if $summary -}}
*Summary:* {{ $summary }}
{{- else -}}
*Summary:* _(no summary annotation)_
{{- end -}}

{{- if $desc -}}
*Description:*
{{ $desc }}
{{- end -}}

*Key labels:*
{{- with (index .CommonLabels "namespace") -}}â€¢ *namespace:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "job") -}}â€¢ *job:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "instance") -}}â€¢ *instance:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "pod") -}}â€¢ *pod:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "service") -}}â€¢ *service:* `{{ . }}`{{ "\n" }}{{- end -}}
{{- with (index .CommonLabels "controller") -}}â€¢ *controller:* `{{ . }}`{{ "\n" }}{{- end -}}

{{- /* Other labels (filtramos los key labels + alertname/severity) */ -}}
{{- $extra := "" -}}
{{- range .CommonLabels.SortedPairs -}}
{{- if and
    (ne .Name "alertname")
    (ne .Name "severity")
    (ne .Name "namespace")
    (ne .Name "job")
    (ne .Name "instance")
    (ne .Name "pod")
    (ne .Name "service")
    (ne .Name "controller")
  -}}
{{- $extra = printf "%sâ€¢ *%s:* `%s`\n" $extra .Name .Value -}}
{{- end -}}
{{- end -}}
{{- if $extra -}}
*Other labels:*
{{ $extra -}}
{{- end -}}

{{- if or $runbook $grafana .ExternalURL -}}
*Links:*
{{- if $runbook }} â€¢ <{{ $runbook }}|ðŸ“˜ Runbook>{{ end -}}
{{- if $grafana }} â€¢ <{{ $grafana }}|ðŸ“ˆ Grafana>{{ end -}}
{{- if .ExternalURL }} â€¢ <{{ .ExternalURL }}|ðŸ”— Alertmanager>{{ end -}}
{{- end -}}
{{- end -}}
