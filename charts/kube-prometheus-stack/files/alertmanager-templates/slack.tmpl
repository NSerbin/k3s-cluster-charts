{{/* =========================================================
   Slack Templates (Alertmanager)
   - slack.title
   - slack.text
   Nota: NO usa funciones sprig (default/dict/list/hasKey)
   ========================================================= */}}

{{ define "slack.title" }}
{{ if eq .Status "firing" }}ðŸš¨ FIRING {{ else }}âœ… RESOLVED {{ end }} | {{ with index .CommonLabels "severity" }}{{ . | toUpper }}{{ else }}UNKNOWN{{ end }} | {{ with index .CommonLabels "alertname" }}{{ . }}{{ else }}Alert{{ end }}
{{ end }}

{{ define "slack.text" }}
{{/* --- Summary --- */}}
*Summary:* {{ with index .CommonAnnotations "summary" }}{{ . }}{{ else }}_(no summary annotation)_{{ end }}

{{/* --- Description --- */}}
{{ with index .CommonAnnotations "description" }}
*Description:*
{{ . }}

{{ end }}

{{/* --- Key labels (solo los importantes, en orden) --- */}}
*Key labels:*
{{ with index .CommonLabels "namespace" }}â€¢ *namespace:* `{{ . }}`{{ end }}
{{ with index .CommonLabels "job" }}â€¢ *job:* `{{ . }}`{{ end }}
{{ with index .CommonLabels "instance" }}â€¢ *instance:* `{{ . }}`{{ end }}
{{ with index .CommonLabels "pod" }}â€¢ *pod:* `{{ . }}`{{ end }}
{{ with index .CommonLabels "service" }}â€¢ *service:* `{{ . }}`{{ end }}
{{ with index .CommonLabels "controller" }}â€¢ *controller:* `{{ . }}`{{ end }}

{{/* --- Other labels (filtrando las anteriores + alertname/severity) --- */}}
{{ $hasExtra := false }}
{{ range .CommonLabels.SortedPairs }}
{{ if and
  (ne .Name "alertname")
  (ne .Name "severity")
  (ne .Name "namespace")
  (ne .Name "job")
  (ne .Name "instance")
  (ne .Name "pod")
  (ne .Name "service")
  (ne .Name "controller")
}}
{{ $hasExtra = true }}
{{ end }}
{{ end }}

{{ if $hasExtra }}
*Other labels:*
{{ range .CommonLabels.SortedPairs }}
{{ if and
  (ne .Name "alertname")
  (ne .Name "severity")
  (ne .Name "namespace")
  (ne .Name "job")
  (ne .Name "instance")
  (ne .Name "pod")
  (ne .Name "service")
  (ne .Name "controller")
}}
â€¢ *{{ .Name }}:* `{{ .Value }}`
{{ end }}
{{ end }}

{{ end }}

{{/* --- Links --- */}}
{{ $runbook := index .CommonAnnotations "runbook_url" }}
{{ $grafana := index .CommonAnnotations "grafana_url" }}
{{ if or $runbook $grafana .ExternalURL }}
*Links:*
{{ with $runbook }}â€¢ ðŸ“˜ <{{ . }}|Runbook>{{ end }}
{{ with $grafana }}â€¢ ðŸ“ˆ <{{ . }}|Grafana>{{ end }}
{{ with .ExternalURL }}â€¢ ðŸ”— <{{ . }}|Alertmanager>{{ end }}
{{ end }}
{{ end }}
