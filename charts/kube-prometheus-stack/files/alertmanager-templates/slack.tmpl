{{/* =========================
   Slack Templates (Alertmanager)
   Defines:
     - slack.title
     - slack.text
   Notes:
     - Works with Alertmanager template funcs (no "default", no "upper")
     - Adds fallback to labels when annotations are missing (amtool case)
   ========================= */}}

{{- define "slack.title" -}}
{{- $status := .Status | toUpper -}}
{{- $emoji := "âœ…" -}}
{{- if eq $status "FIRING" -}}{{- $emoji = "ðŸš¨" -}}{{- end -}}

{{- $sev := "" -}}
{{- if (index .CommonLabels "severity") -}}
  {{- $sev = (index .CommonLabels "severity") | toUpper -}}
{{- else -}}
  {{- $sev = "UNKNOWN" -}}
{{- end -}}

{{- $name := "" -}}
{{- if (index .CommonLabels "alertname") -}}
  {{- $name = (index .CommonLabels "alertname") -}}
{{- else -}}
  {{- $name = "Alert" -}}
{{- end -}}

{{ $emoji }} {{ $status }} | {{ $sev }} | {{ $name }}
{{- end -}}

{{- define "slack.text" -}}
{{- /* Fallbacks: if annotations missing, allow summary/description in labels (amtool) */ -}}
{{- $summary := "" -}}
{{- if (index .CommonAnnotations "summary") -}}
  {{- $summary = index .CommonAnnotations "summary" -}}
{{- else if (index .CommonLabels "summary") -}}
  {{- $summary = index .CommonLabels "summary" -}}
{{- end -}}

{{- $desc := "" -}}
{{- if (index .CommonAnnotations "description") -}}
  {{- $desc = index .CommonAnnotations "description" -}}
{{- else if (index .CommonLabels "description") -}}
  {{- $desc = index .CommonLabels "description" -}}
{{- end -}}

{{- $runbook := "" -}}
{{- if (index .CommonAnnotations "runbook_url") -}}
  {{- $runbook = index .CommonAnnotations "runbook_url" -}}
{{- end -}}

{{- /* ===== Summary ===== */ -}}
*Summary:* {{- if $summary -}} {{ $summary }}{{- else -}} _(missing summary)_{{- end }}

{{- /* ===== Description ===== */ -}}
{{- if $desc }}
*Description:*
{{ $desc }}
{{- end }}

{{- /* ===== Key labels ===== */ -}}
*Key labels:*
{{- if (index .CommonLabels "namespace") }}â€¢ *namespace:* `{{ index .CommonLabels "namespace" }}`{{ end }}
{{- if (index .CommonLabels "pod") }}â€¢ *pod:* `{{ index .CommonLabels "pod" }}`{{ end }}
{{- if (index .CommonLabels "container") }}â€¢ *container:* `{{ index .CommonLabels "container" }}`{{ end }}
{{- if (index .CommonLabels "job") }}â€¢ *job:* `{{ index .CommonLabels "job" }}`{{ end }}
{{- if (index .CommonLabels "instance") }}â€¢ *instance:* `{{ index .CommonLabels "instance" }}`{{ end }}

{{- /* ===== Links ===== */ -}}
*Links:*
{{- if $runbook }}â€¢ ðŸ“˜ <{{ $runbook }}|Runbook>{{ end }}
{{- if .ExternalURL }}â€¢ ðŸ”— <{{ .ExternalURL }}|Alertmanager>{{ end }}
{{- end -}}
