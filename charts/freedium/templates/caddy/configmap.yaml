apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "freedium.fullname" . }}-caddy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "freedium.labels" . | nindent 4 }}
data:
  Caddyfile: |
    {
      auto_https off
      log {
        output stdout
        level {{ .Values.caddy.logLevel | default "INFO" }}
      }
    }

    :{{ .Values.caddy.port }} {
      encode gzip zstd

      # ✅ FIX Medium sin redirect loop:
      # Solo reescribe cuando viene /https:/... (1 slash), NO cuando ya es /https://...
      @bad_scheme path_regexp bad ^/(https?):/([^/].*)$
      redir @bad_scheme /{re.bad.1}://{re.bad.2} 302

      # 1) Si el path corresponde a un archivo que existe en /static, lo servimos.
      @static file {
        root /static
        try_files {path}
      }
      handle @static {
        root * /static
        file_server
      }

      # 2) También soportar /static/* por si alguna vez el HTML lo usa
      handle_path /static/* {
        root * /static
        file_server
      }

      # 3) Todo lo demás al backend
      handle {
        reverse_proxy 127.0.0.1:7080
      }
    }
