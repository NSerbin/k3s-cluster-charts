apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "freedium.fullname" . }}-caddy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "freedium.labels" . | nindent 4 }}
data:
  Caddyfile: |
    {
      auto_https off
      log {
        output stdout
        level {{ .Values.caddy.logLevel | default "INFO" }}
      }
    }

    :{{ .Values.caddy.port }} {
      encode gzip zstd

      # Frontend estático (debe existir en la imagen ghcr.io/nserbin/freedium-caddy)
      root * /srv
      file_server

      # SPA fallback (si tu frontend es single-page)
      try_files {path} /index.html

      # === Backend/API ===
      # Ajustá paths según el proyecto real (estos suelen cubrirlo)
      reverse_proxy /api/* 127.0.0.1:7080 {
        header_up Host {host}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Port {server_port}
      }

      reverse_proxy /docs* 127.0.0.1:7080 {
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
      }

      reverse_proxy /openapi.json 127.0.0.1:7080 {
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
      }
    }
